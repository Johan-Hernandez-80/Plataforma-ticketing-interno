create database ticketing;
use ticketing;

create table usuarios (
    id int auto_increment primary key,
    nombre varchar(100) not null,
    email_personal varchar(100) unique,
    email_corporativo varchar(100) unique not null,
    contrasena varchar(200) not null,
    rol varchar(50) not null,
    departamento varchar(50) not null,
    
    constraint chk_rol CHECK (rol IN ('admin', 'agente', 'usuario'))
);

create table categorias (
    id int auto_increment primary key,
    nombre varchar(100) not null,
    descripcion varchar(600)
);


create table tickets (
    id int auto_increment primary key,
    usuario_id int not null,
    categoria_id int not null,
    titulo varchar(200) not null,
    descripcion varchar(600) not null,
    prioridad varchar(30) not null,
    estado varchar(60) not null,
    fecha_creacion date not null,
    fecha_cierre date,

    constraint fk_tickets_usuarios
	foreign key (usuario_id) references usuarios(id),

    constraint fk_tickets_categorias
	foreign key (categoria_id) references categorias(id)
);

create table asignaciones (
    id int auto_increment primary key,
    ticket_id int not null,
    agente_id int not null,
    fecha_creacion date not null,

    constraint fk_asignaciones_tickets
	foreign key (ticket_id) references tickets(id),

    constraint fk_asignaciones_usuarios
	foreign key (agente_id) references usuarios(id)
);

create table comentarios (
    id int auto_increment primary key,
    ticket_id int not null,
    usuario_id int not null,
    comentario varchar(600) not null,
    fecha_creacion date not null,

    constraint fk_comentarios_tickets
	foreign key (ticket_id) references tickets(id),

    constraint fk_comentarios_usuarios
	foreign key (usuario_id) references usuarios(id)
);

create table historial_tickets (
    id int auto_increment primary key,
    ticket_id int not null,
    estado_anterior varchar(50) not null,
    estado_nuevo varchar(50) not null,
    fecha_cambio date not null,

    constraint fk_historialtickets_tickets
	foreign key (ticket_id) references tickets(id)
);
